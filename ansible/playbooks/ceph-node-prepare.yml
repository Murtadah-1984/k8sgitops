---
- name: Prepare Ceph nodes for Rook-Ceph
  hosts: ceph
  become: true
  gather_facts: yes

  vars:
    ceph_required_packages:
      - lvm2
      - nvme-cli
      - sg3-utils
      - smartmontools
      - jq

  tasks:
    - name: Install Ceph dependencies
      ansible.builtin.package:
        name: "{{ ceph_required_packages }}"
        state: present

    - name: Disable swap (Ceph + K8s requirement)
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb | int > 0

    - name: Remove swap from fstab
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '(^.*swap.*$)'
        replace: '# \1'

    - name: Set Ceph-related sysctl
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-ceph-tuning.conf
        content: |
          vm.swappiness = 1
          vm.vfs_cache_pressure = 50
          vm.dirty_ratio = 10
          vm.dirty_background_ratio = 5
          net.core.somaxconn = 4096
      notify: Reload sysctl

    - name: Ensure time sync is installed (chrony or systemd-timesyncd)
      ansible.builtin.package:
        name: chrony
        state: present

    - name: Enable & start chronyd
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: true

  handlers:
    - name: Reload sysctl
      ansible.builtin.command: sysctl --system

